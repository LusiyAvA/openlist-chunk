# OpenList 代理配置 - 针对大文件上传优化
# 放置在 /usr/local/openresty/nginx/conf/conf.d/openlist.conf

# 上游服务器定义
upstream openlist_backend {
    server 127.0.0.1:5244 max_fails=3 fail_timeout=30s;
    keepalive 32;          # 保持32个长连接
    keepalive_requests 100;
    keepalive_timeout 120s;
}

# 限流配置（防止滥用，无WAF时的基础防护）
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/s;      # API接口限流
limit_req_zone $binary_remote_addr zone=upload_limit:10m rate=5r/s;    # 上传接口限流
limit_req_zone $binary_remote_addr zone=download_limit:10m rate=10r/s; # 下载接口限流

# IP黑名单映射（可选的安全措施）
# geo $blocked_ip {
#     default 0;
#     # 示例：封禁特定IP
#     # 192.168.1.100 1;
#     # 10.0.0.0/8 1;
# }

server {
    listen 80;
    server_name _;  # 替换为你的域名
    
    # 日志配置
    access_log /var/log/nginx/openlist_access.log main buffer=32k flush=5s;
    error_log /var/log/nginx/openlist_error.log warn;
    
    # 安全头部（无WAF时的基础防护）
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # 客户端上传配置（针对大文件优化）
    client_max_body_size 102400m;           # 100GB 最大上传
    client_body_buffer_size 512k;           # 客户端缓冲区
    client_header_timeout 60s;              # 读取客户端header超时
    client_body_timeout 86400s;             # 24小时客户端传输超时
    send_timeout 86400s;                    # 24小时发送超时
    
    # 临时文件配置（确保有足够空间）
    client_body_temp_path /tmp/nginx_upload_temp 1 2;
    
    # 根路径代理
    location / {
        # IP黑名单检查（可选）
        # if ($blocked_ip) {
        #     return 403 "Access Denied";
        # }
        
        # 基础限流（API接口）
        limit_req zone=api_limit burst=20 nodelay;
        limit_req_status 429;
        
        proxy_pass http://openlist_backend;
        
        # 禁用请求缓冲（关键配置！立即转发到后端）
        proxy_request_buffering off;
        
        # 代理超时配置（24小时）
        proxy_connect_timeout 60s;
        proxy_send_timeout 86400s;          # 24小时写超时
        proxy_read_timeout 86400s;          # 24小时读超时
        
        # HTTP版本和连接复用
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # 禁用响应缓冲（流式传输）
        proxy_buffering off;
        
        # 代理缓冲区配置（虽然禁用了buffering，但仍需要设置）
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        
        # Header传递
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Range支持（断点续传）
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
        
        # 隐藏后端版本信息
        proxy_hide_header X-Powered-By;
        proxy_hide_header Server;
    }
    
    # 文件上传接口（额外的限流和优化）
    location ~ ^/api/fs/(put|form) {
        # 上传接口专用限流（更严格）
        limit_req zone=upload_limit burst=3 nodelay;
        limit_req_status 429;
        
        # 限制单个IP的并发上传连接数
        limit_conn perip 5;
        limit_conn_status 503;
        
        proxy_pass http://openlist_backend;
        
        # 关键：禁用请求缓冲
        proxy_request_buffering off;
        
        # 超长超时（大文件上传可能需要数小时）
        proxy_connect_timeout 60s;
        proxy_send_timeout 86400s;
        proxy_read_timeout 86400s;
        
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 上传进度支持（需要nginx-upload-progress模块）
        # track_uploads uploads 30s;
    }
    
    # 文件下载接口（流式传输优化）
    location ~ ^/(d|p|ad|ap)/ {
        # 下载接口限流
        limit_req zone=download_limit burst=10 nodelay;
        
        proxy_pass http://openlist_backend;
        
        # 下载不需要关闭请求缓冲（请求体很小）
        proxy_request_buffering on;
        
        # 响应不缓冲（流式下载）
        proxy_buffering off;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 86400s;
        proxy_read_timeout 86400s;
        
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Range支持（断点续传）
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
        
        # 忽略客户端中断（避免后端日志报错）
        proxy_ignore_client_abort off;
    }
    
    # WebDAV接口（如果使用）
    location /dav/ {
        limit_req zone=api_limit burst=20 nodelay;
        
        proxy_pass http://openlist_backend;
        proxy_request_buffering off;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 86400s;
        proxy_read_timeout 86400s;
        
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebDAV需要的额外方法
        proxy_set_header Destination $http_destination;
        proxy_set_header Depth $http_depth;
    }
    
    # 健康检查
    location /ping {
        access_log off;
        proxy_pass http://openlist_backend;
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
    }
    
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# HTTPS 配置（如果需要）
# server {
#     listen 443 ssl http2;
#     server_name your-domain.com;
#     
#     # SSL证书配置
#     ssl_certificate /path/to/cert.pem;
#     ssl_certificate_key /path/to/key.pem;
#     
#     # SSL优化配置
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
#     ssl_prefer_server_ciphers on;
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 10m;
#     
#     # HSTS（强制HTTPS）
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#     
#     # 其他配置与HTTP相同
#     # ... （复制上面的location配置）
# }
